---
title: "Section 4: Demand for Cigarettes and Instrumental Variables"
subtitle: "<html><div style='float:left'></div><hr color='#EB811B' size=1px width=1050px></html>"
author: Ian McCarthy | Emory University
date: Econ 470 & HLTH 470 #"`r format(Sys.time(), '%d %B %Y')`"
header-includes: 
  - \usepackage{graphicx}
  - \usepackage{amsmath}
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts, custom.css] 
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      beforeInit: "macros.js"
---

<!-- Adjust some CSS code for font size and maintain R code font size -->
<style type="text/css">
.remark-slide-content {
    font-size: 30px;
    padding: 1em 2em 1em 2em;    
}
.remark-code {
  font-size: 15px;
}
.remark-inline-code { 
    font-size: 20px;
}
</style>


<!-- Set R options for how code chunks are displayed and load packages -->
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(knitr)
knitr::opts_chunk$set(
  fig.align="center",  
  fig.height=3, #fig.width=6,
  # out.width="748px", #out.length="520.75px",
  dpi=300, #fig.path='Figs/',
  cache=T,# echo=F, warning=F, message=F
  warning = FALSE, 
  message = FALSE, 
  cache.lazy = FALSE,
  error=TRUE
  )

knitr::opts_hooks$set(fig.callout = function(options) {
  if(options$fig.callout) {
    options$echo = FALSE
  }
  options
})

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, readr, readxl, hrbrthemes,
               scales, plotly, gganimate, cobalt, ivpack)
```

# Table of contents

1. [Cigarettes and Prices](#smoking_lit)

2. [Instrumental Variables](#IV)

3. [Cigarette Data](#smoking_data)

4. [Estimated Demand for Cigarettes](#smoking_demand)



<!-- New Section -->
---
class: inverse, center, middle
name: smoking_lit

# Background on Cigarettes and Pricing

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>


---
# 



<!-- New Section -->
---
class: inverse, center, middle
name: IV

# Instrumental Variables

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>


---
# What is instrumental variables
Instrumental Variables (IV) is a way to identify causal effects using variation in treatment particpation that is due to an *exogenous* variable that is only related to the outcome through treatment.

---
# What does that mean?
- The regression we want to do: <br>
$y_{i} = \alpha + \delta W_{i} + \gamma A_{i} + \epsilon_{i}$,<br>
where $W_{i}$ is treatment (think of schooling for now) and $A_{i}$ is something like ability.

- $A_{i}$ is unobserved, so instead we run: <br>
$y_{i} = \alpha + \beta W_{i} + \epsilon_{i}$

- From this "short" regression, we don't actually estimate $\delta$. Instead, we get an estimate of<br>
$\beta = \delta + \lambda_{ws}\gamma \neq \delta$,<br>
where $\lambda_{ws}$ is the coefficient of a regression of $A_{i}$ on $W_{i}$. 

---
# Intuition
IV will recover the "long" regression without observing underlying ability<br>

--
*IF* our IV satisfies all of the necessary assumptions.

---
# More formally
- We want to estimate<br>
$E[Y_{i} | W_{i}=1] - E[Y_{i} | W_{i}=0]$

- With instrument $Z_{i}$ that satisfies relevant assumptions, we can estimate this as<br>
$E[Y_{i} | W_{i}=1] - E[Y_{i} | W_{i}=0] = \frac{E[Y_{i} | Z_{i}=1] - E[Y_{i} | Z_{i}=0]}{E[W_{i} | Z_{i}=1] - E[W_{i} | Z_{i}=0]}$

- In words, this is effect of the instrument on the outcome ("reduced form") divded by the effect of the instrument on treatment ("first stage")

---
# What is IV *doing*
Think of IV as two-steps:

1. Isolate variation due to the instrument only (not due to endogenous stuff)
2. Estimate effect on outcome using only this source of variation



<!-- New Section -->
---
class: inverse, center, middle
name: smoking_data

# Cigarette Data

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>


---
# The Data
```{r eval=T, include=F}
#hcris.data <- read_rds("D:/CloudStation/Professional/Research Projects/_Git/CDC-Tobacco/data/TaxBurden_Data.rds")

cig.data <- read_rds("C:/Users/immccar/CloudStation/Professional/Research Projects/_Git/CDC-Tobacco/data/TaxBurden_Data.rds")
```

```{r cig-price, eval=FALSE, warning=FALSE}
cig.data %>% 
  ggplot(aes(x=Year,y=cost_per_pack)) + 
  stat_summary(fun.y="mean",geom="line") +
  labs(
    x="Year",
    y="Price per Pack ($)",
    title="Cigarette Prices"
  ) + theme_bw() +
  scale_x_continuous(breaks=seq(1970, 2020, 5))
```
.plot-callout[
```{r cig-price-callout, ref.label="cig-price", fig.callout=TRUE, warning=FALSE}
```
]


<!-- New Section -->
---
class: inverse, center, middle
name: smoking_demand

# Estimating Demand for Cigarettes

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

---
# Naive estimate
Let's start with just OLS:
```{r}
ols <- lm(sales_per_capita ~ cost_per_pack, data=cig.data)
summary(ols)
```

---
# IV Estimate
```{r}
ivs <- ivreg(sales_per_capita ~ cost_per_pack | tax_percent, 
             data=cig.data)
```

```{r}
cig.data %>% 
  ggplot(aes(x=Year,y=tax_dollar)) + 
  stat_summary(fun.y="mean",geom="line") +
  labs(
    x="Year",
    y="Tax per Pack ($)",
    title="Cigarette Prices"
  ) + theme_bw() +
  scale_x_continuous(breaks=seq(1970, 2020, 5))
```