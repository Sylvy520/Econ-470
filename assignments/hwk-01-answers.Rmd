---
title: "Homework 1 Answer Key"
author: "Econ 470/HLTH 470: Research in Health Economics"
date: "Due: Sunday, February 9"
output: 
  bookdown::html_document2:
    toc: TRUE
    toc_float: TRUE
    theme: darkly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, stringr, readxl, data.table, gdata, scales)
```

# Enrollment Data
Answer the following based on the enrollment data:

1. How many observations exist in your current dataset?<br>

First we need to create the enrollment data. Working with the Medicare Advantage Github Repository, you should have created a "full.ma.data" object. The following code reads this dataset into `R` and counts the total number of plans:

```{r}
full.ma.data <- readRDS("D:/CloudStation/Professional/Research Projects/_Git/Medicare-Advantage/data/full_ma_data.rds")
tot.obs <- count(full.ma.data %>% ungroup())
```
So we have `r format(tot.obs, big.mark=",")` total observations in the full dataset, which means there are `r format(tot.obs, big.mark=",")` unique combinations of contract/plan/county/year. 



2. How many different *plan_types* exist in the data? <br>

We need to tabulate the different plan types:
```{r}
plan.type.table <- full.ma.data %>% group_by(plan_type) %>% count() %>% arrange(-n)
knitr::kable(plan.type.table, col.names=c("Plan Type","Count"), format.args=list(big.mark=","))
```
The resulting table yields `r nrow(plan.type.table)` rows, so there are `r nrow(plan.type.table)` total plan types. I've provided the counts of each plan type just for extra detail.


3. Provide a table of the count of plans under each plan type in each year.<br>

```{r}
plan.type.year <- full.ma.data %>% group_by(plan_type, year) %>% count() %>% arrange(year, -n)
plan.type.year <- pivot_wider(plan.type.year, names_from="year",values_from="n", names_prefix="Count_")
options(knitr.kable.NA = 0)
knitr::kable(plan.type.year, col.names=c("Plan Type","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015"), format.args=list(big.mark=","))
```

4. Remove all special needs plans (SNP), employer group plans (eghp), and all "800-series" plans.<br>

Counts of different plan types over time are presented in Table \@ref(tab:plan_type).

```{r plan_type}
final.data <- full.ma.data %>%
  filter(snp == "No" & eghp == "No" &
           (planid < 800 | planid >= 900))
plan.type.year <- final.data %>% group_by(plan_type, year) %>% count() %>% arrange(year, -n)
plan.type.year <- pivot_wider(plan.type.year, names_from="year",values_from="n", names_prefix="Count_")
options(knitr.kable.NA = 0)
knitr::kable(plan.type.year, col.names=c("Plan Type","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015"), format.args=list(big.mark=","),type="html", caption = "Plan Count by Year", booktabs = TRUE)
``` 

5. Merge the the contract service area data to the enrollment data and restrict the data only to contracts that are approved in their respective counties.<br>

Let's first read in the contract service area data:
```{r}
contract.service.area <- readRDS("D:/CloudStation/Professional/Research Projects/_Git/Medicare-Advantage/data/contract_service_area.rds")
```

Now we can join that dataset to our MA data. I'm going to use an inner join, which means I'm only taking rows that match in both datasets.
```{r}
final.data <- final.data %>%
  inner_join(contract.service.area %>% 
               select(contractid, fips, year), 
             by=c("contractid", "fips", "year"))
```
  

6. Finally, limit your dataset only to plans with non-missing enrollment data. Provide a graph showing the average number of Medicare Advantage enrollees per county from 2008 to 2015.<br>
```{r}
final.data <- final.data %>%
  filter(!is.na(avg_enrollment))

final.data %>%
  group_by(fips, year) %>% 
  select(fips, year, avg_enrollment) %>% 
  summarize(all_enroll=sum(avg_enrollment)) %>%
  ggplot(aes(x=as.factor(year),y=all_enroll)) + 
  stat_summary(fun.y="mean", geom="bar") +
  labs(
    x="Year",
    y="People",
    title="Average Number of MA Enrollees per County"
  ) + scale_y_continuous(labels=comma) +
  theme_bw()
```

# Premium Data

1. Merge the plan characteristics data to the dataset you created in Step 6 above.<br>

As mentioned in the instructions, we first need to merge in the market penetration data to provide a crosswalk between the plan/contract info and the plan characteristics. 
```{r}
ma.penetration.data <- readRDS("D:/CloudStation/Professional/Research Projects/_Git/Medicare-Advantage/data/ma_penetration.rds")
final.data <- final.data %>%
  left_join( ma.penetration.data %>% ungroup() %>%
               rename(state_long=state, county_long=county), 
             by=c("fips", "year"))
```

Next we need to fill in the state information. I do this by creating a table of unique state names and then merging this back to the original data:
```{r}
final.state <- final.data %>% 
  group_by(state) %>% 
  summarize(state_name=last(state_long, na.rm=TRUE))

final.data <- final.data %>%
  left_join(final.state,
            by=c("state"))
```

Finally, we can read in the premium data and merge that information to the final dataset
```{r}
plan.premiums <- readRDS("D:/CloudStation/Professional/Research Projects/_Git/Medicare-Advantage/data/plan_premiums.rds")
final.data <- final.data %>%
  left_join( plan.premiums,
             by=c("contractid","planid","state_name"="state","county","year"))
```

2. Provide a graph showing the average premium over time. Don't forget about formatting!

```{r}
final.data %>% ungroup() %>% group_by(year) %>%
  summarize(avg_prem=mean(premium, na.rm=TRUE)) %>%
  ggplot
```


3. Provide a graph showing the percentage of $0 premium plans over time. Also...remember to format things.

```{r}
final.data %>% ungroup() %>%
  mutate(prem_0=(premium==0),
         prem_na=(is.na(premium))) %>%
  group_by(year) %>%
  summarize(all_count=n(),prem_0=sum(prem_0, na.rm=TRUE), prem_na=sum(prem_na))

```





# Summary Questions
With all of this data work and these great summaries, let's take a step back and think about what all this means.

1. Why did we drop the "800-series" plans?

2. Why do so many plans charge a $0 premium? What does that really mean to a beneficiary?

3. Briefly describe your experience working with these data (just a few sentences). Tell me one thing you learned and one thing that really aggravated you.
